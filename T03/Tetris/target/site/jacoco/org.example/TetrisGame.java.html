<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TetrisGame.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">DemoJunit</a> &gt; <a href="index.source.html" class="el_package">org.example</a> &gt; <span class="el_source">TetrisGame.java</span></div><h1>TetrisGame.java</h1><pre class="source lang-java linenums">package org.example;

import java.awt.*;
import java.awt.event.*;
import javax.swing.*;
import javax.swing.border.TitledBorder;
import java.util.Random;

public class TetrisGame extends JFrame {
    private static final int BOARD_WIDTH = 10;
    private static final int BOARD_HEIGHT = 20;
    private static final int BLOCK_SIZE = 35;
    private static final int PREVIEW_SIZE = 6;

    private TetrisBoard board;
    private Timer gameTimer;
    private Tetromino currentTetromino;
    private int score;
    private JLabel scoreLabel;
    private Tetromino nextTetromino;
<span class="nc" id="L21">    private int level = 1;</span>
    private long gameStartTime;
<span class="nc" id="L23">    private boolean debugModeEnabled = false;</span>
    private Tetromino ghostPiece;
    private TetrominoType[] tetrominoBag;
    private int currentBagIndex;
    private Tetromino savedTetromino; // 儲存的方塊
<span class="nc" id="L28">    private boolean hasSavedTetromino = false; // 標記是否已經儲存過方塊</span>
    private ScoreManager scoreManager;  // 新增這行

<span class="nc" id="L31">    public TetrisGame() {</span>
<span class="nc" id="L32">        initializeGame();</span>
<span class="nc" id="L33">        setupGameUI();</span>
<span class="nc" id="L34">        setupGameLogic();</span>
<span class="nc" id="L35">    }</span>

    private void initializeGame() {
<span class="nc" id="L38">        setTitle(&quot;Tetris Game&quot;);</span>
<span class="nc" id="L39">        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);</span>
<span class="nc" id="L40">        setResizable(false);</span>
<span class="nc" id="L41">        board = new TetrisBoard(BOARD_WIDTH, BOARD_HEIGHT);</span>
<span class="nc" id="L42">        scoreManager = new ScoreManager();  // 初始化 ScoreManager</span>
<span class="nc" id="L43">        scoreLabel = new JLabel(&quot;Score: 0&quot;);</span>
<span class="nc" id="L44">        scoreLabel.setFont(new Font(&quot;Arial&quot;, Font.BOLD, 24));</span>
<span class="nc" id="L45">        scoreLabel.setForeground(Color.WHITE);</span>
<span class="nc" id="L46">        level = 1;</span>
<span class="nc" id="L47">        initializeTetrominoBag();</span>
<span class="nc" id="L48">        currentBagIndex = 0;</span>
<span class="nc" id="L49">    }</span>

    private void initializeTetrominoBag() {
<span class="nc" id="L52">        tetrominoBag = new TetrominoType[7];</span>
<span class="nc" id="L53">        TetrominoType[] types = TetrominoType.values();</span>
<span class="nc" id="L54">        System.arraycopy(types, 0, tetrominoBag, 0, types.length);</span>
<span class="nc" id="L55">        shuffleBag();</span>
<span class="nc" id="L56">    }</span>

    private void shuffleBag() {
<span class="nc" id="L59">        Random random = new Random();</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">        for (int i = tetrominoBag.length - 1; i &gt; 0; i--) {</span>
<span class="nc" id="L61">            int index = random.nextInt(i + 1);</span>
<span class="nc" id="L62">            TetrominoType temp = tetrominoBag[index];</span>
<span class="nc" id="L63">            tetrominoBag[index] = tetrominoBag[i];</span>
<span class="nc" id="L64">            tetrominoBag[i] = temp;</span>
        }
<span class="nc" id="L66">    }</span>

    private Tetromino createRandomTetromino() {
<span class="nc" id="L69">        TetrominoType nextType = tetrominoBag[currentBagIndex];</span>
<span class="nc" id="L70">        currentBagIndex++;</span>

<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (currentBagIndex &gt;= tetrominoBag.length) {</span>
<span class="nc" id="L73">            shuffleBag();</span>
<span class="nc" id="L74">            currentBagIndex = 0;</span>
        }

<span class="nc" id="L77">        return new Tetromino(nextType, BOARD_WIDTH / 2 - 1, 0);</span>
    }

    private void debugMode() {
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (score &gt; 500) {</span>
<span class="nc" id="L82">            System.out.println(&quot;High Score Reached!&quot;);</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">            if (score &gt; 1000) {</span>
<span class="nc" id="L84">                System.out.println(&quot;Achievement Unlocked: Tetris Master!&quot;);</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            } else if (score &gt; 800) {</span>
<span class="nc" id="L86">                System.out.println(&quot;Keep going! Almost there!&quot;);</span>
            } else {
<span class="nc" id="L88">                System.out.println(&quot;Good progress!&quot;);</span>
            }
        } else {
<span class="nc" id="L91">            System.out.println(&quot;Score is below 500. Keep trying!&quot;);</span>
        }

<span class="nc bnc" id="L94" title="All 2 branches missed.">        for (int i = 0; i &lt; 5; i++) {</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">            if (i % 2 == 0) {</span>
<span class="nc" id="L96">                System.out.println(&quot;Debug iteration: &quot; + i);</span>
            }
        }
<span class="nc" id="L99">    }</span>

    private void bonusPointsChecker(int level, int timeTaken) {
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (level &gt; 10) {</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (timeTaken &lt; 300) {</span>
<span class="nc" id="L104">                score += 100;</span>
<span class="nc" id="L105">                System.out.println(&quot;Bonus points awarded for speed!&quot;);</span>
            } else {
<span class="nc" id="L107">                score += 50;</span>
<span class="nc" id="L108">                System.out.println(&quot;Bonus points for reaching a high level!&quot;);</span>
            }
<span class="nc bnc" id="L110" title="All 2 branches missed.">        } else if (level &gt; 5) {</span>
<span class="nc" id="L111">            score += 20;</span>
<span class="nc" id="L112">            System.out.println(&quot;Small bonus for intermediate level.&quot;);</span>
        } else {
<span class="nc" id="L114">            System.out.println(&quot;No bonus points.&quot;);</span>
        }

<span class="nc bnc" id="L117" title="All 4 branches missed.">        switch (level) {</span>
<span class="nc" id="L118">            case 1 -&gt; System.out.println(&quot;Beginner level.&quot;);</span>
<span class="nc" id="L119">            case 5 -&gt; System.out.println(&quot;Intermediate level reached!&quot;);</span>
<span class="nc" id="L120">            case 10 -&gt; System.out.println(&quot;Expert level reached!&quot;);</span>
<span class="nc" id="L121">            default -&gt; System.out.println(&quot;Keep climbing!&quot;);</span>
        }
<span class="nc" id="L123">    }</span>

    private boolean advancedCollisionCheck(Tetromino tetromino) {
<span class="nc" id="L126">        boolean collisionDetected = false;</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">        for (int y = 0; y &lt; BOARD_HEIGHT; y++) {</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            for (int x = 0; x &lt; BOARD_WIDTH; x++) {</span>
<span class="nc bnc" id="L129" title="All 6 branches missed.">                if (board.boardState[y][x] == 1 &amp;&amp; (x == tetromino.getX() &amp;&amp; y == tetromino.getY())) {</span>
<span class="nc" id="L130">                    collisionDetected = true;</span>
<span class="nc" id="L131">                    break;</span>
                }
            }
        }
<span class="nc" id="L135">        return collisionDetected;</span>
    }

    private void performSpecialMove() {
<span class="nc" id="L139">        System.out.println(&quot;Performing a special move!&quot;);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (i % 2 == 0) {</span>
<span class="nc" id="L142">                System.out.println(&quot;Even step in special move: &quot; + i);</span>
            } else {
<span class="nc" id="L144">                System.out.println(&quot;Odd step in special move: &quot; + i);</span>
            }
        }
<span class="nc" id="L147">    }</span>

    private void setupGameUI() {
<span class="nc" id="L150">        setLayout(new BorderLayout(10, 10));</span>

<span class="nc" id="L152">        JPanel sidePanel = new JPanel(new BorderLayout(0, 20));</span>
<span class="nc" id="L153">        sidePanel.setPreferredSize(new Dimension(PREVIEW_SIZE * BLOCK_SIZE + 20, BOARD_HEIGHT * BLOCK_SIZE));</span>
<span class="nc" id="L154">        sidePanel.setBackground(Color.BLACK);</span>

<span class="nc" id="L156">        JPanel previewPanel = new PreviewPanel();</span>
<span class="nc" id="L157">        sidePanel.add(previewPanel, BorderLayout.NORTH);</span>

<span class="nc" id="L159">        JPanel savedPanel = new JPanel();</span>
<span class="nc" id="L160">        savedPanel.setPreferredSize(new Dimension(BLOCK_SIZE * 4, BLOCK_SIZE * 4));</span>
<span class="nc" id="L161">        savedPanel.setBackground(Color.GRAY);</span>
<span class="nc" id="L162">        sidePanel.add(savedPanel, BorderLayout.CENTER);</span>

<span class="nc" id="L164">        JPanel scorePanel = new JPanel();</span>
<span class="nc" id="L165">        scorePanel.setBackground(Color.BLACK);</span>
<span class="nc" id="L166">        scorePanel.add(scoreLabel);</span>
<span class="nc" id="L167">        sidePanel.add(scorePanel, BorderLayout.SOUTH);</span>

<span class="nc" id="L169">        JPanel gamePanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L170">        gamePanel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));</span>
<span class="nc" id="L171">        gamePanel.add(board, BorderLayout.CENTER);</span>

<span class="nc" id="L173">        add(gamePanel, BorderLayout.CENTER);</span>
<span class="nc" id="L174">        add(sidePanel, BorderLayout.EAST);</span>

<span class="nc" id="L176">        ((JPanel) getContentPane()).setBorder(</span>
<span class="nc" id="L177">                BorderFactory.createEmptyBorder(20, 20, 20, 20)</span>
        );

<span class="nc" id="L180">        pack();</span>
<span class="nc" id="L181">        setLocationRelativeTo(null);</span>
<span class="nc" id="L182">    }</span>

    private void setupGameLogic() {
<span class="nc" id="L185">        gameTimer = new Timer(scoreManager.getGameSpeed(), new ActionListener() {</span>
            @Override
            public void actionPerformed(ActionEvent e) {
<span class="nc" id="L188">                moveTetrominoDown();</span>
<span class="nc" id="L189">            }</span>
        });

<span class="nc" id="L192">        addKeyListener(new KeyAdapter() {</span>
            @Override
            public void keyPressed(KeyEvent e) {
<span class="nc" id="L195">                handleKeyPress(e);</span>
<span class="nc" id="L196">            }</span>
        });

<span class="nc" id="L199">        startNewGame();</span>
<span class="nc" id="L200">    }</span>

    private void startNewGame() {
<span class="nc" id="L203">        board.clearBoard();</span>
<span class="nc" id="L204">        score = 0;</span>
<span class="nc" id="L205">        updateScoreDisplay();</span>
<span class="nc" id="L206">        nextTetromino = createRandomTetromino();</span>
<span class="nc" id="L207">        spawnNewTetromino();</span>
<span class="nc" id="L208">        gameTimer.setDelay(scoreManager.getGameSpeed());</span>
<span class="nc" id="L209">        gameTimer.start();</span>
<span class="nc" id="L210">        requestFocusInWindow();</span>

<span class="nc" id="L212">    }</span>

    private void spawnNewTetromino() {
<span class="nc" id="L215">        currentTetromino = nextTetromino;</span>
<span class="nc" id="L216">        nextTetromino = createRandomTetromino();</span>

        // 檢查當前方塊的 Y 坐標是否超過可容納的最高處
<span class="nc bnc" id="L219" title="All 2 branches missed.">        if (currentTetromino.getY() &lt; 0) { // 如果 Y 坐標小於 0，則遊戲結束</span>
<span class="nc" id="L220">            gameOver();</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">        } else if (!board.canPlaceTetromino(currentTetromino)) {</span>
<span class="nc" id="L222">            gameOver();</span>
        }
<span class="nc" id="L224">        repaint();</span>
<span class="nc" id="L225">    }</span>

    private void moveTetrominoDown() {
<span class="nc" id="L228">        Tetromino newPosition = new Tetromino(currentTetromino);</span>
<span class="nc" id="L229">        newPosition.moveDown();</span>

<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (board.canPlaceTetromino(newPosition)) {</span>
<span class="nc" id="L232">            currentTetromino = newPosition;</span>
        } else {
<span class="nc" id="L234">            board.placeTetromino(currentTetromino);</span>
<span class="nc" id="L235">            int linesCleared = board.checkAndClearLines();</span>
<span class="nc" id="L236">            updateScore(linesCleared);</span>
<span class="nc" id="L237">            spawnNewTetromino();</span>
<span class="nc" id="L238">            gameTimer.setDelay(scoreManager.getGameSpeed());</span>
        }

<span class="nc" id="L241">        board.repaint();</span>
<span class="nc" id="L242">    }</span>

    private void updateGhostPiece() {
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (currentTetromino == null) return;</span>

<span class="nc" id="L247">        ghostPiece = new Tetromino(currentTetromino);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">        while (isValidMove(ghostPiece.getX(), ghostPiece.getY() + 1, ghostPiece.getCurrentShape())) {</span>
<span class="nc" id="L249">            ghostPiece.moveDown();</span>
        }
<span class="nc" id="L251">    }</span>

    private boolean isValidMove(int newX, int newY, int[][] shape) {
<span class="nc bnc" id="L254" title="All 2 branches missed.">        for (int row = 0; row &lt; shape.length; row++) {</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">            for (int col = 0; col &lt; shape[row].length; col++) {</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">                if (shape[row][col] == 1) {</span>
<span class="nc" id="L257">                    int x = newX + col;</span>
<span class="nc" id="L258">                    int y = newY + row;</span>

<span class="nc bnc" id="L260" title="All 6 branches missed.">                    if (x &lt; 0 || x &gt;= BOARD_WIDTH || y &gt;= BOARD_HEIGHT) {</span>
<span class="nc" id="L261">                        return false;</span>
                    }

<span class="nc bnc" id="L264" title="All 4 branches missed.">                    if (y &gt;= 0 &amp;&amp; board.boardState[y][x] == 1) {</span>
<span class="nc" id="L265">                        return false;</span>
                    }
                }
            }
        }
<span class="nc" id="L270">        return true;</span>
    }

    private void handleKeyPress(KeyEvent e) {
<span class="nc" id="L274">        Tetromino newPosition = new Tetromino(currentTetromino);</span>

<span class="nc bnc" id="L276" title="All 8 branches missed.">        switch (e.getKeyCode()) {</span>
            case KeyEvent.VK_LEFT:
<span class="nc" id="L278">                newPosition.moveLeft();</span>
<span class="nc" id="L279">                break;</span>
            case KeyEvent.VK_RIGHT:
<span class="nc" id="L281">                newPosition.moveRight();</span>
<span class="nc" id="L282">                break;</span>
            case KeyEvent.VK_DOWN:
<span class="nc" id="L284">                newPosition.moveDown();</span>
<span class="nc" id="L285">                break;</span>
            case KeyEvent.VK_UP:
<span class="nc bnc" id="L287" title="All 2 branches missed.">                if (board.canRotateTetromino(currentTetromino)) {</span>
<span class="nc" id="L288">                    newPosition.rotate();</span>
                }
                break;
            case KeyEvent.VK_Z:  // 添加 Z 鍵進行反向旋轉
<span class="nc bnc" id="L292" title="All 2 branches missed.">                if (board.canRotateTetromino(currentTetromino)) {</span>
<span class="nc" id="L293">                    newPosition.rotateReverse();</span>
                }
                break;
            case KeyEvent.VK_SPACE:
<span class="nc" id="L297">                hardDrop();</span>
<span class="nc" id="L298">                return;</span>
            case KeyEvent.VK_C:  // 按下 C 鍵儲存或交換方塊
<span class="nc bnc" id="L300" title="All 2 branches missed.">                if (!hasSavedTetromino) {</span>
<span class="nc" id="L301">                    savedTetromino = new Tetromino(currentTetromino); // 儲存當前方塊</span>
<span class="nc" id="L302">                    hasSavedTetromino = true; // 標記為已儲存</span>
<span class="nc" id="L303">                    System.out.println(&quot;Tetromino saved!&quot;);</span>
<span class="nc" id="L304">                    spawnNewTetromino(); // 生成下一個方塊</span>
                } else {
<span class="nc" id="L306">                    Tetromino temp = currentTetromino; // 交換當前方塊和儲存的方塊</span>
<span class="nc" id="L307">                    currentTetromino = savedTetromino;</span>
<span class="nc" id="L308">                    savedTetromino = temp;</span>
<span class="nc" id="L309">                    currentTetromino.setX(BOARD_WIDTH / 2 - 1); // 設置為預設 X 坐標</span>
<span class="nc" id="L310">                    currentTetromino.setY(0); // 設置為預設 Y 坐標</span>
<span class="nc" id="L311">                    System.out.println(&quot;Swapped with saved tetromino!&quot;);</span>
                }
<span class="nc" id="L313">                return;</span>
        }

<span class="nc bnc" id="L316" title="All 2 branches missed.">        if (board.canPlaceTetromino(newPosition)) {</span>
<span class="nc" id="L317">            currentTetromino = newPosition;</span>
<span class="nc" id="L318">            updateGhostPiece();</span>
<span class="nc" id="L319">            board.repaint();</span>
        }
<span class="nc" id="L321">    }</span>

    private void hardDrop() {
<span class="nc bnc" id="L324" title="All 2 branches missed.">        while (board.canPlaceTetromino(new Tetromino(currentTetromino).moveDown())) {</span>
<span class="nc" id="L325">            currentTetromino.moveDown();</span>
        }

<span class="nc" id="L328">        board.placeTetromino(currentTetromino);</span>
<span class="nc" id="L329">        int linesCleared = board.checkAndClearLines();</span>
<span class="nc" id="L330">        updateScore(linesCleared);</span>
<span class="nc" id="L331">        spawnNewTetromino();</span>
<span class="nc" id="L332">        board.repaint();</span>
<span class="nc" id="L333">    }</span>

    private void updateScore(int linesCleared) {
<span class="nc" id="L336">        int oldLevel = scoreManager.getLevel();</span>
<span class="nc" id="L337">        scoreManager.updateScore(linesCleared);</span>

        // 如果等級改變，立即更新遊戲速度
<span class="nc bnc" id="L340" title="All 2 branches missed.">        if (oldLevel != scoreManager.getLevel()) {</span>
<span class="nc" id="L341">            gameTimer.setDelay(scoreManager.getGameSpeed());</span>
        }

<span class="nc" id="L344">        updateScoreDisplay();</span>
<span class="nc" id="L345">    }</span>

    private void updateScoreDisplay() {
<span class="nc" id="L348">        scoreLabel.setText(String.format(&quot;Score: %d | Level: %d&quot;,</span>
<span class="nc" id="L349">                scoreManager.getScore(),</span>
<span class="nc" id="L350">                scoreManager.getLevel()));</span>
<span class="nc" id="L351">    }</span>

    private void gameOver() {
<span class="nc" id="L354">        gameTimer.stop();</span>
<span class="nc" id="L355">        UIManager.put(&quot;OptionPane.messageFont&quot;, new Font(&quot;Arial&quot;, Font.BOLD, 20));</span>
<span class="nc" id="L356">        UIManager.put(&quot;OptionPane.buttonFont&quot;, new Font(&quot;Arial&quot;, Font.BOLD, 16));</span>

<span class="nc" id="L358">        int choice = JOptionPane.showConfirmDialog(</span>
                this,
<span class="nc" id="L360">                &quot;Game Over!\nYour score: &quot; + scoreManager.getScore() + &quot;\nDo you want to restart?&quot;,</span>
                &quot;Game Over&quot;,
                JOptionPane.YES_NO_OPTION
        );

<span class="nc bnc" id="L365" title="All 2 branches missed.">        if (choice == JOptionPane.YES_OPTION) {</span>
<span class="nc" id="L366">            scoreManager.setScore(0);</span>
<span class="nc" id="L367">            scoreManager.setLevel(1);</span>
<span class="nc" id="L368">            startNewGame();</span>
        } else {
<span class="nc" id="L370">            System.exit(0);</span>
        }
<span class="nc" id="L372">    }</span>

    public int getScore() {
<span class="nc" id="L375">        return scoreManager.getScore();</span>
    }

    public int getLevel() {
<span class="nc" id="L379">        return scoreManager.getLevel();</span>
    }

    public static void main(String[] args) {
<span class="nc" id="L383">        SwingUtilities.invokeLater(() -&gt; {</span>
<span class="nc" id="L384">            new TetrisGame().setVisible(true);</span>
<span class="nc" id="L385">        });</span>
<span class="nc" id="L386">    }</span>

    // Tetromino Type Enum
<span class="nc" id="L389">    private enum TetrominoType {</span>
<span class="nc" id="L390">        I(new int[][][]{</span>
                {{1, 1, 1, 1}},
                {{1}, {1}, {1}, {1}}
        }),
<span class="nc" id="L394">        O(new int[][][]{</span>
                {{1, 1}, {1, 1}}
        }),
<span class="nc" id="L397">        T(new int[][][]{</span>
                {{0, 1, 0}, {1, 1, 1}},
                {{1, 0}, {1, 1}, {1, 0}},
                {{1, 1, 1}, {0, 1, 0}},
                {{0, 1}, {1, 1}, {0, 1}}
        }),
<span class="nc" id="L403">        L(new int[][][]{</span>
                {{1, 0}, {1, 0}, {1, 1}},
                {{1, 1, 1}, {1, 0, 0}},
                {{1, 1}, {0, 1}, {0, 1}},
                {{0, 0, 1}, {1, 1, 1}}
        }),
<span class="nc" id="L409">        J(new int[][][]{</span>
                {{0, 1}, {0, 1}, {1, 1}},
                {{1, 0, 0}, {1, 1, 1}},
                {{1, 1}, {1, 0}, {1, 0}},
                {{1, 1, 1}, {0, 0, 1}}
        }),
<span class="nc" id="L415">        S(new int[][][]{</span>
                {{0, 1, 1}, {1, 1, 0}},
                {{1, 0}, {1, 1}, {0, 1}}
        }),
<span class="nc" id="L419">        Z(new int[][][]{</span>
                {{1, 1, 0}, {0, 1, 1}},
                {{0, 1}, {1, 1}, {1, 0}}
        });

        private final int[][][] shapes;

<span class="nc" id="L426">        TetrominoType(int[][][] shapes) {</span>
<span class="nc" id="L427">            this.shapes = shapes;</span>
<span class="nc" id="L428">        }</span>

        public int[][][] getShapes() {
<span class="nc" id="L431">            return shapes;</span>
        }
    }

    // Tetromino Class
    private class Tetromino {
        private int x, y;
        private TetrominoType type;
        private int currentRotation;

<span class="nc" id="L441">        public Tetromino(TetrominoType type, int startX, int startY) {</span>
<span class="nc" id="L442">            this.type = type;</span>
<span class="nc" id="L443">            this.x = startX;</span>
<span class="nc" id="L444">            this.y = startY;</span>
<span class="nc" id="L445">            this.currentRotation = 0;</span>
<span class="nc" id="L446">        }</span>

<span class="nc" id="L448">        public Tetromino(Tetromino other) {</span>
<span class="nc" id="L449">            this.x = other.x;</span>
<span class="nc" id="L450">            this.y = other.y;</span>
<span class="nc" id="L451">            this.type = other.type;</span>
<span class="nc" id="L452">            this.currentRotation = other.currentRotation;</span>
<span class="nc" id="L453">        }</span>

        public Tetromino moveLeft() {
<span class="nc" id="L456">            x--;</span>
<span class="nc" id="L457">            return this;</span>
        }

        public Tetromino moveRight() {
<span class="nc" id="L461">            x++;</span>
<span class="nc" id="L462">            return this;</span>
        }

        public Tetromino moveDown() {
<span class="nc" id="L466">            y++;</span>
<span class="nc" id="L467">            return this;</span>
        }

        public Tetromino moveUp() {
<span class="nc" id="L471">            y--;</span>
<span class="nc" id="L472">            return this;</span>
        }

        public Tetromino rotate() {
<span class="nc" id="L476">            currentRotation = (currentRotation + 1) % type.getShapes().length;</span>
<span class="nc" id="L477">            return this;</span>
        }

        public Tetromino rotateReverse() {
<span class="nc" id="L481">            currentRotation = (currentRotation - 1 + type.getShapes().length) % type.getShapes().length;</span>
<span class="nc" id="L482">            return this;</span>
        }

        public int[][] getCurrentShape() {
<span class="nc" id="L486">            return type.getShapes()[currentRotation];</span>
        }

        public int getX() {
<span class="nc" id="L490">            return x;</span>
        }

        public int getY() {
<span class="nc" id="L494">            return y;</span>
        }

        public void setX(int newX) {
<span class="nc" id="L498">            this.x = newX;</span>
<span class="nc" id="L499">        }</span>

        public void setY(int newY) {
<span class="nc" id="L502">            this.y = newY;</span>
<span class="nc" id="L503">        }</span>
    }

    // TetrisBoard Class
    private class TetrisBoard extends JPanel {
        private int width, height;
        private int[][] boardState;

<span class="nc" id="L511">        public TetrisBoard(int width, int height) {</span>
<span class="nc" id="L512">            this.width = width;</span>
<span class="nc" id="L513">            this.height = height;</span>
<span class="nc" id="L514">            this.boardState = new int[height][width];</span>
<span class="nc" id="L515">            setPreferredSize(new Dimension(width * BLOCK_SIZE, height * BLOCK_SIZE));</span>
<span class="nc" id="L516">            setBackground(Color.BLACK);</span>
<span class="nc" id="L517">        }</span>

        public void clearBoard() {
<span class="nc" id="L520">            boardState = new int[height][width];</span>
<span class="nc" id="L521">        }</span>

        public boolean canPlaceTetromino(Tetromino tetromino) {
<span class="nc" id="L524">            return isValidMove(tetromino.getX(), tetromino.getY(), tetromino.getCurrentShape());</span>
        }

        public boolean canRotateTetromino(Tetromino tetromino) {
<span class="nc" id="L528">            Tetromino rotatedTetromino = new Tetromino(tetromino);</span>
<span class="nc" id="L529">            rotatedTetromino.rotate(); // 嘗試旋轉</span>

            //檢查旋轉後的位置是否有效
<span class="nc bnc" id="L532" title="All 2 branches missed.">            if (isValidMove(rotatedTetromino.getX(), rotatedTetromino.getY(), rotatedTetromino.getCurrentShape())) {</span>
<span class="nc" id="L533">                return true;</span>
            }

            // 如果旋轉後無法放置，嘗試踢牆
            // 嘗試向左踢牆
<span class="nc" id="L538">            rotatedTetromino.setX(rotatedTetromino.getX() - 1);</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">            if (isValidMove(rotatedTetromino.getX(), rotatedTetromino.getY(), rotatedTetromino.getCurrentShape())) {</span>
<span class="nc" id="L540">                return true;</span>
            }

            // 嘗試向右踢牆
<span class="nc" id="L544">            rotatedTetromino.setX(rotatedTetromino.getX() + 2); // 向右移動兩格</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">            if (isValidMove(rotatedTetromino.getX(), rotatedTetromino.getY(), rotatedTetromino.getCurrentShape())) {</span>
<span class="nc" id="L546">                return true;</span>
            }

<span class="nc" id="L549">            return false; // 如果所有嘗試都失敗，返回 false</span>
        }

        public void placeTetromino(Tetromino tetromino) {
<span class="nc" id="L553">            int[][] shape = tetromino.getCurrentShape();</span>
<span class="nc" id="L554">            int startX = tetromino.getX();</span>
<span class="nc" id="L555">            int startY = tetromino.getY();</span>

<span class="nc bnc" id="L557" title="All 2 branches missed.">            for (int row = 0; row &lt; shape.length; row++) {</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">                for (int col = 0; col &lt; shape[row].length; col++) {</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">                    if (shape[row][col] == 1) {</span>
<span class="nc" id="L560">                        int boardY = startY + row;</span>
<span class="nc" id="L561">                        int boardX = startX + col;</span>

                        // 確保不會超出邊界
<span class="nc bnc" id="L564" title="All 8 branches missed.">                        if (boardY &gt;= 0 &amp;&amp; boardY &lt; BOARD_HEIGHT &amp;&amp;</span>
                                boardX &gt;= 0 &amp;&amp; boardX &lt; BOARD_WIDTH) {
<span class="nc" id="L566">                            boardState[boardY][boardX] = 1; // 更新狀態</span>
                        }
                    }
                }
            }
<span class="nc" id="L571">        }</span>

        public int checkAndClearLines() {
<span class="nc" id="L574">            int linesCleared = 0;</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">            for (int y = height - 1; y &gt;= 0; y--) {</span>
<span class="nc" id="L576">                boolean lineIsFull = true;</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">                for (int x = 0; x &lt; width; x++) {</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">                    if (boardState[y][x] == 0) {</span>
<span class="nc" id="L579">                        lineIsFull = false;</span>
<span class="nc" id="L580">                        break;</span>
                    }
                }

<span class="nc bnc" id="L584" title="All 2 branches missed.">                if (lineIsFull) {</span>
<span class="nc" id="L585">                    linesCleared++;</span>
<span class="nc" id="L586">                    removeLine(y);</span>
<span class="nc" id="L587">                    y++; // Recheck the same row after removing a line</span>
                }
            }
<span class="nc" id="L590">            return linesCleared;</span>
        }

        private void removeLine(int lineToRemove) {
<span class="nc bnc" id="L594" title="All 2 branches missed.">            for (int y = lineToRemove; y &gt; 0; y--) {</span>
<span class="nc" id="L595">                System.arraycopy(boardState[y - 1], 0, boardState[y], 0, width);</span>
            }
            // Clear the top line
<span class="nc" id="L598">            boardState[0] = new int[width];</span>
<span class="nc" id="L599">        }</span>

        @Override
        protected void paintComponent(Graphics g) {
<span class="nc" id="L603">            super.paintComponent(g);</span>

            // 繪製網格
<span class="nc" id="L606">            g.setColor(Color.DARK_GRAY);</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">            for (int x = 0; x &lt; width; x++) {</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">                for (int y = 0; y &lt; height; y++) {</span>
<span class="nc" id="L609">                    g.drawRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);</span>
                }
            }

            // 繪製已置的方塊
<span class="nc" id="L614">            g.setColor(Color.CYAN);</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">            for (int y = 0; y &lt; height; y++) {</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">                for (int x = 0; x &lt; width; x++) {</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">                    if (boardState[y][x] == 1) {</span>
<span class="nc" id="L618">                        g.fillRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);</span>
                    }
                }
            }

            // 繪製預測方塊（ghost piece）
<span class="nc bnc" id="L624" title="All 2 branches missed.">            if (ghostPiece != null) {</span>
<span class="nc" id="L625">                g.setColor(new Color(255, 255, 255, 30));  // 更透明</span>
<span class="nc" id="L626">                int[][] ghostShape = ghostPiece.getCurrentShape();</span>
<span class="nc" id="L627">                int ghostX = ghostPiece.getX();</span>
<span class="nc" id="L628">                int ghostY = ghostPiece.getY();</span>

<span class="nc bnc" id="L630" title="All 2 branches missed.">                for (int row = 0; row &lt; ghostShape.length; row++) {</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">                    for (int col = 0; col &lt; ghostShape[row].length; col++) {</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">                        if (ghostShape[row][col] == 1) {</span>
<span class="nc" id="L633">                            g.fillRect(</span>
                                    (ghostX + col) * BLOCK_SIZE,
                                    (ghostY + row) * BLOCK_SIZE,
                                    BLOCK_SIZE,
                                    BLOCK_SIZE
                            );
                        }
                    }
                }
            }

            // 繪製當前方塊
<span class="nc bnc" id="L645" title="All 2 branches missed.">            if (currentTetromino != null) {</span>
<span class="nc" id="L646">                g.setColor(Color.GREEN);</span>
<span class="nc" id="L647">                int[][] shape = currentTetromino.getCurrentShape();</span>
<span class="nc" id="L648">                int startX = currentTetromino.getX();</span>
<span class="nc" id="L649">                int startY = currentTetromino.getY();</span>

<span class="nc bnc" id="L651" title="All 2 branches missed.">                for (int row = 0; row &lt; shape.length; row++) {</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">                    for (int col = 0; col &lt; shape[row].length; col++) {</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">                        if (shape[row][col] == 1) {</span>
<span class="nc" id="L654">                            g.fillRect(</span>
                                    (startX + col) * BLOCK_SIZE,
                                    (startY + row) * BLOCK_SIZE,
                                    BLOCK_SIZE,
                                    BLOCK_SIZE
                            );
                        }
                    }
                }
            }

            // 繪製儲存的方塊
<span class="nc" id="L666">            paintSavedTetromino(g);</span>
<span class="nc" id="L667">        }</span>
    }

    // PreviewPanel Class
    private class PreviewPanel extends JPanel {
<span class="nc" id="L672">        public PreviewPanel() {</span>
<span class="nc" id="L673">            setPreferredSize(new Dimension(PREVIEW_SIZE * BLOCK_SIZE, PREVIEW_SIZE * BLOCK_SIZE));</span>
<span class="nc" id="L674">            setBackground(Color.BLACK);</span>
<span class="nc" id="L675">            setBorder(BorderFactory.createTitledBorder(</span>
<span class="nc" id="L676">                    BorderFactory.createLineBorder(Color.GRAY, 2),</span>
                    &quot;Next&quot;,
                    TitledBorder.CENTER,
                    TitledBorder.TOP,
                    new Font(&quot;Arial&quot;, Font.BOLD, 20),
                    Color.WHITE
            ));
<span class="nc" id="L683">        }</span>

        @Override
        protected void paintComponent(Graphics g) {
<span class="nc" id="L687">            super.paintComponent(g);</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">            if (nextTetromino != null) {</span>
<span class="nc" id="L689">                g.setColor(Color.GREEN);</span>
<span class="nc" id="L690">                int[][] shape = nextTetromino.getCurrentShape();</span>

                // Calculate center position
<span class="nc" id="L693">                int centerX = (PREVIEW_SIZE - shape[0].length) * BLOCK_SIZE / 2;</span>
<span class="nc" id="L694">                int centerY = (PREVIEW_SIZE - shape.length) * BLOCK_SIZE / 2;</span>

<span class="nc bnc" id="L696" title="All 2 branches missed.">                for (int row = 0; row &lt; shape.length; row++) {</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">                    for (int col = 0; col &lt; shape[row].length; col++) {</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">                        if (shape[row][col] == 1) {</span>
<span class="nc" id="L699">                            g.fillRect(</span>
                                    centerX + col * BLOCK_SIZE,
                                    centerY + row * BLOCK_SIZE,
                                    BLOCK_SIZE,
                                    BLOCK_SIZE
                            );
                        }
                    }
                }
            }
<span class="nc" id="L709">        }</span>
    }

    // 添加更新遊戲速度的方法
    private void updateGameSpeed() {
<span class="nc" id="L714">        int newSpeed = scoreManager.getGameSpeed();</span>
<span class="nc" id="L715">        gameTimer.setDelay(newSpeed);</span>
<span class="nc" id="L716">    }</span>

    // 添加方塊來使用儲存的方塊
    private void useSavedTetromino() {
<span class="nc bnc" id="L720" title="All 2 branches missed.">        if (savedTetromino != null) {</span>
<span class="nc" id="L721">            currentTetromino = savedTetromino; // 使用儲存的方塊</span>
<span class="nc" id="L722">            savedTetromino = null; // 清空儲存的方塊</span>
<span class="nc" id="L723">            hasSavedTetromino = false; // 重置標記</span>
<span class="nc" id="L724">            System.out.println(&quot;Using saved tetromino!&quot;);</span>
        } else {
<span class="nc" id="L726">            System.out.println(&quot;No tetromino saved.&quot;);</span>
        }
<span class="nc" id="L728">    }</span>

    // 修改 paintComponent 方法以顯示儲存的方塊
    private void paintSavedTetromino(Graphics g) {
<span class="nc bnc" id="L732" title="All 2 branches missed.">        if (savedTetromino != null) {</span>
<span class="nc" id="L733">            g.setColor(Color.YELLOW); // 儲存方塊的顏色</span>
<span class="nc" id="L734">            int[][] shape = savedTetromino.getCurrentShape();</span>
<span class="nc" id="L735">            int startX = 10; // 儲存區的 X 坐標</span>
<span class="nc" id="L736">            int startY = 5;  // 儲存區的 Y 坐標，調整為預覽區域下方</span>

<span class="nc bnc" id="L738" title="All 2 branches missed.">            for (int row = 0; row &lt; shape.length; row++) {</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">                for (int col = 0; col &lt; shape[row].length; col++) {</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">                    if (shape[row][col] == 1) {</span>
<span class="nc" id="L741">                        g.fillRect(</span>
                                (startX + col) * BLOCK_SIZE,
                                (startY + row) * BLOCK_SIZE,
                                BLOCK_SIZE,
                                BLOCK_SIZE
                        );
                    }
                }
            }
        }
<span class="nc" id="L751">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>